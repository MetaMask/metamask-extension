<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="google" content="notranslate">
    <meta http-equiv="Content-Language" content="en">
    <title>lib/personal-message-manager.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
    <script src="scripts/semantic.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/semantic.min.css">
    <link type="text/css" rel="stylesheet" href="styles/override.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="ComposableObservableStore.html">ComposableObservableStore</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="ComposableObservableStore.html#getFlatState">getFlatState</a></li><li data-type='method'><a href="ComposableObservableStore.html#updateStructure">updateStructure</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="ComputedbalancesController.html">ComputedbalancesController</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="ComputedbalancesController.html#syncAllAccountsFromStore">syncAllAccountsFromStore</a></li><li data-type='method'><a href="ComputedbalancesController.html#trackAddress">trackAddress</a></li><li data-type='method'><a href="ComputedbalancesController.html#trackAddressIfNotAlready">trackAddressIfNotAlready</a></li><li data-type='method'><a href="ComputedbalancesController.html#updateAllBalances">updateAllBalances</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="DetectTokensController.html">DetectTokensController</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="DetectTokensController.html#detectNewTokens">detectNewTokens</a></li><li data-type='method'><a href="DetectTokensController.html#detectTokenBalance">detectTokenBalance</a></li><li data-type='method'><a href="DetectTokensController.html#restartTokenDetection">restartTokenDetection</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="EdgeEncryptor.html">EdgeEncryptor</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="EdgeEncryptor.html#decrypt">decrypt</a></li><li data-type='method'><a href="EdgeEncryptor.html#encrypt">encrypt</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="Migrator.html">Migrator</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="Migrator.html#generateInitialState">generateInitialState</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="NonceTracker.html">NonceTracker</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="NonceTracker.html#_getHighestContinuousFrom">_getHighestContinuousFrom</a></li><li data-type='method'><a href="NonceTracker.html#getGlobalLock">getGlobalLock</a></li><li data-type='method'><a href="NonceTracker.html#getNonceLock">getNonceLock</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="PendingTransactionTracker.html">PendingTransactionTracker</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="PendingTransactionTracker.html#_checkIfNonceIsTaken">_checkIfNonceIsTaken</a></li><li data-type='method'><a href="PendingTransactionTracker.html#_checkPendingTx">_checkPendingTx</a></li><li data-type='method'><a href="PendingTransactionTracker.html#_resubmitTx">_resubmitTx</a></li><li data-type='method'><a href="PendingTransactionTracker.html#resubmitPendingTxs">resubmitPendingTxs</a></li><li data-type='method'><a href="PendingTransactionTracker.html#updatePendingTxs">updatePendingTxs</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="TokenRatesController.html">TokenRatesController</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="TokenRatesController.html#fetchExchangeRate">fetchExchangeRate</a></li><li data-type='method'><a href="TokenRatesController.html#updateExchangeRates">updateExchangeRates</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="TransactionController.html">TransactionController</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="TransactionController.html#_mapMethods">_mapMethods</a></li><li data-type='method'><a href="TransactionController.html#_markNonceDuplicatesDropped">_markNonceDuplicatesDropped</a></li><li data-type='method'><a href="TransactionController.html#_onBootCleanUp">_onBootCleanUp</a></li><li data-type='method'><a href="TransactionController.html#_setupListeners">_setupListeners</a></li><li data-type='method'><a href="TransactionController.html#_updateMemstore">_updateMemstore</a></li><li data-type='method'><a href="TransactionController.html#addTx">addTx</a></li><li data-type='method'><a href="TransactionController.html#addTxGasDefaults">addTxGasDefaults</a></li><li data-type='method'><a href="TransactionController.html#addUnapprovedTransaction">addUnapprovedTransaction</a></li><li data-type='method'><a href="TransactionController.html#approveTransaction">approveTransaction</a></li><li data-type='method'><a href="TransactionController.html#cancelTransaction">cancelTransaction</a></li><li data-type='method'><a href="TransactionController.html#createCancelTransaction">createCancelTransaction</a></li><li data-type='method'><a href="TransactionController.html#getChainId">getChainId</a></li><li data-type='method'><a href="TransactionController.html#getFilteredTxList">getFilteredTxList</a></li><li data-type='method'><a href="TransactionController.html#getNetwork">getNetwork</a></li><li data-type='method'><a href="TransactionController.html#getPendingTxCount">getPendingTxCount</a></li><li data-type='method'><a href="TransactionController.html#getSelectedAddress">getSelectedAddress</a></li><li data-type='method'><a href="TransactionController.html#getState">getState</a></li><li data-type='method'><a href="TransactionController.html#getUnapprovedTxCount">getUnapprovedTxCount</a></li><li data-type='method'><a href="TransactionController.html#newUnapprovedTransaction">newUnapprovedTransaction</a></li><li data-type='method'><a href="TransactionController.html#publishTransaction">publishTransaction</a></li><li data-type='method'><a href="TransactionController.html#retryTransaction">retryTransaction</a></li><li data-type='method'><a href="TransactionController.html#setTxHash">setTxHash</a></li><li data-type='method'><a href="TransactionController.html#signTransaction">signTransaction</a></li><li data-type='method'><a href="TransactionController.html#updateAndApproveTransaction">updateAndApproveTransaction</a></li><li data-type='method'><a href="TransactionController.html#updateTransaction">updateTransaction</a></li><li data-type='method'><a href="TransactionController.html#wipeTransactions">wipeTransactions</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="TransactionStateManager.html">TransactionStateManager</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="TransactionStateManager.html#_saveTxList">_saveTxList</a></li><li data-type='method'><a href="TransactionStateManager.html#_setTxStatus">_setTxStatus</a></li><li data-type='method'><a href="TransactionStateManager.html#addTx">addTx</a></li><li data-type='method'><a href="TransactionStateManager.html#generateTxMeta">generateTxMeta</a></li><li data-type='method'><a href="TransactionStateManager.html#getConfirmedTransactions">getConfirmedTransactions</a></li><li data-type='method'><a href="TransactionStateManager.html#getFullTxList">getFullTxList</a></li><li data-type='method'><a href="TransactionStateManager.html#getPendingTransactions">getPendingTransactions</a></li><li data-type='method'><a href="TransactionStateManager.html#getTx">getTx</a></li><li data-type='method'><a href="TransactionStateManager.html#getTxList">getTxList</a></li><li data-type='method'><a href="TransactionStateManager.html#getTxsByMetaData">getTxsByMetaData</a></li><li data-type='method'><a href="TransactionStateManager.html#getTxStatus">getTxStatus</a></li><li data-type='method'><a href="TransactionStateManager.html#getUnapprovedTxList">getUnapprovedTxList</a></li><li data-type='method'><a href="TransactionStateManager.html#setTxStatusApproved">setTxStatusApproved</a></li><li data-type='method'><a href="TransactionStateManager.html#setTxStatusConfirmed">setTxStatusConfirmed</a></li><li data-type='method'><a href="TransactionStateManager.html#setTxStatusDropped">setTxStatusDropped</a></li><li data-type='method'><a href="TransactionStateManager.html#setTxStatusFailed">setTxStatusFailed</a></li><li data-type='method'><a href="TransactionStateManager.html#setTxStatusRejected">setTxStatusRejected</a></li><li data-type='method'><a href="TransactionStateManager.html#setTxStatusSigned">setTxStatusSigned</a></li><li data-type='method'><a href="TransactionStateManager.html#setTxStatusSubmitted">setTxStatusSubmitted</a></li><li data-type='method'><a href="TransactionStateManager.html#setTxStatusUnapproved">setTxStatusUnapproved</a></li><li data-type='method'><a href="TransactionStateManager.html#updateTx">updateTx</a></li><li data-type='method'><a href="TransactionStateManager.html#updateTxParams">updateTxParams</a></li><li data-type='method'><a href="TransactionStateManager.html#validateTxParams">validateTxParams</a></li><li data-type='method'><a href="TransactionStateManager.html#wipeTransactions">wipeTransactions</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="TxGasUtil.html">TxGasUtil</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="TxGasUtil.html#addGasBuffer">addGasBuffer</a></li><li data-type='method'><a href="TxGasUtil.html#analyzeGasUsage">analyzeGasUsage</a></li><li data-type='method'><a href="TxGasUtil.html#estimateTxGas">estimateTxGas</a></li><li data-type='method'><a href="TxGasUtil.html#setTxGas">setTxGas</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="module.html#.exports">exports</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="module.html#.exports#addMsg">addMsg</a></li><li data-type='method'><a href="module.html#.exports#addMsg">addMsg</a></li><li data-type='method'><a href="module.html#.exports#addMsg">addMsg</a></li><li data-type='method'><a href="module.html#.exports#addMsg">addMsg</a></li><li data-type='method'><a href="module.html#.exports#addMsg">addMsg</a></li><li data-type='method'><a href="module.html#.exports#addNewAccount">addNewAccount</a></li><li data-type='method'><a href="module.html#.exports#addUnapprovedMessage">addUnapprovedMessage</a></li><li data-type='method'><a href="module.html#.exports#addUnapprovedMessage">addUnapprovedMessage</a></li><li data-type='method'><a href="module.html#.exports#addUnapprovedMessage">addUnapprovedMessage</a></li><li data-type='method'><a href="module.html#.exports#addUnapprovedMessage">addUnapprovedMessage</a></li><li data-type='method'><a href="module.html#.exports#addUnapprovedMessage">addUnapprovedMessage</a></li><li data-type='method'><a href="module.html#.exports#addUnapprovedMessageAsync">addUnapprovedMessageAsync</a></li><li data-type='method'><a href="module.html#.exports#addUnapprovedMessageAsync">addUnapprovedMessageAsync</a></li><li data-type='method'><a href="module.html#.exports#addUnapprovedMessageAsync">addUnapprovedMessageAsync</a></li><li data-type='method'><a href="module.html#.exports#approveMessage">approveMessage</a></li><li data-type='method'><a href="module.html#.exports#approveMessage">approveMessage</a></li><li data-type='method'><a href="module.html#.exports#approveMessage">approveMessage</a></li><li data-type='method'><a href="module.html#.exports#approveMessage">approveMessage</a></li><li data-type='method'><a href="module.html#.exports#approveMessage">approveMessage</a></li><li data-type='method'><a href="module.html#.exports#buyEth">buyEth</a></li><li data-type='method'><a href="module.html#.exports#cancelMessage">cancelMessage</a></li><li data-type='method'><a href="module.html#.exports#cancelPersonalMessage">cancelPersonalMessage</a></li><li data-type='method'><a href="module.html#.exports#cancelTypedMessage">cancelTypedMessage</a></li><li data-type='method'><a href="module.html#.exports#checkHardwareStatus">checkHardwareStatus</a></li><li data-type='method'><a href="module.html#.exports#clearSeedWordCache">clearSeedWordCache</a></li><li data-type='method'><a href="module.html#.exports#connectHardware">connectHardware</a></li><li data-type='method'><a href="module.html#.exports#createCancelTransaction">createCancelTransaction</a></li><li data-type='method'><a href="module.html#.exports#createNewVaultAndKeychain">createNewVaultAndKeychain</a></li><li data-type='method'><a href="module.html#.exports#createNewVaultAndRestore">createNewVaultAndRestore</a></li><li data-type='method'><a href="module.html#.exports#createShapeShiftTx">createShapeShiftTx</a></li><li data-type='method'><a href="module.html#.exports#forgetDevice">forgetDevice</a></li><li data-type='method'><a href="module.html#.exports#get">get</a></li><li data-type='method'><a href="module.html#.exports#getApi">getApi</a></li><li data-type='method'><a href="module.html#.exports#getBalance">getBalance</a></li><li data-type='method'><a href="module.html#.exports#getGasPrice">getGasPrice</a></li><li data-type='method'><a href="module.html#.exports#getMsg">getMsg</a></li><li data-type='method'><a href="module.html#.exports#getMsg">getMsg</a></li><li data-type='method'><a href="module.html#.exports#getMsg">getMsg</a></li><li data-type='method'><a href="module.html#.exports#getMsg">getMsg</a></li><li data-type='method'><a href="module.html#.exports#getMsg">getMsg</a></li><li data-type='method'><a href="module.html#.exports#getState">getState</a></li><li data-type='method'><a href="module.html#.exports#getUnapprovedMsgs">getUnapprovedMsgs</a></li><li data-type='method'><a href="module.html#.exports#getUnapprovedMsgs">getUnapprovedMsgs</a></li><li data-type='method'><a href="module.html#.exports#getUnapprovedMsgs">getUnapprovedMsgs</a></li><li data-type='method'><a href="module.html#.exports#getUnapprovedMsgs">getUnapprovedMsgs</a></li><li data-type='method'><a href="module.html#.exports#getUnapprovedMsgs">getUnapprovedMsgs</a></li><li data-type='method'><a href="module.html#.exports#importAccountWithStrategy">importAccountWithStrategy</a></li><li data-type='method'><a href="module.html#.exports#importLostAccounts">importLostAccounts</a></li><li data-type='method'><a href="module.html#.exports#initializeProvider">initializeProvider</a></li><li data-type='method'><a href="module.html#.exports#initPublicConfigStore">initPublicConfigStore</a></li><li data-type='method'><a href="module.html#.exports#markAccountsFound">markAccountsFound</a></li><li data-type='method'><a href="module.html#.exports#markPasswordForgotten">markPasswordForgotten</a></li><li data-type='method'><a href="module.html#.exports#newUnapprovedTransaction">newUnapprovedTransaction</a></li><li data-type='method'><a href="module.html#.exports#newUnsignedMessage">newUnsignedMessage</a></li><li data-type='method'><a href="module.html#.exports#newUnsignedPersonalMessage">newUnsignedPersonalMessage</a></li><li data-type='method'><a href="module.html#.exports#newUnsignedTypedMessage">newUnsignedTypedMessage</a></li><li data-type='method'><a href="module.html#.exports#normalizeMsgData">normalizeMsgData</a></li><li data-type='method'><a href="module.html#.exports#placeSeedWords">placeSeedWords</a></li><li data-type='method'><a href="module.html#.exports#prepMsgForSigning">prepMsgForSigning</a></li><li data-type='method'><a href="module.html#.exports#prepMsgForSigning">prepMsgForSigning</a></li><li data-type='method'><a href="module.html#.exports#prepMsgForSigning">prepMsgForSigning</a></li><li data-type='method'><a href="module.html#.exports#prepMsgForSigning">prepMsgForSigning</a></li><li data-type='method'><a href="module.html#.exports#prepMsgForSigning">prepMsgForSigning</a></li><li data-type='method'><a href="module.html#.exports#rejectMsg">rejectMsg</a></li><li data-type='method'><a href="module.html#.exports#rejectMsg">rejectMsg</a></li><li data-type='method'><a href="module.html#.exports#rejectMsg">rejectMsg</a></li><li data-type='method'><a href="module.html#.exports#rejectMsg">rejectMsg</a></li><li data-type='method'><a href="module.html#.exports#rejectMsg">rejectMsg</a></li><li data-type='method'><a href="module.html#.exports#removeAccount">removeAccount</a></li><li data-type='method'><a href="module.html#.exports#resetAccount">resetAccount</a></li><li data-type='method'><a href="module.html#.exports#restoreOldVaultAccounts">restoreOldVaultAccounts</a></li><li data-type='method'><a href="module.html#.exports#retryTransaction">retryTransaction</a></li><li data-type='method'><a href="module.html#.exports#selectFirstIdentity">selectFirstIdentity</a></li><li data-type='method'><a href="module.html#.exports#set">set</a></li><li data-type='method'><a href="module.html#.exports#setCurrentCurrency">setCurrentCurrency</a></li><li data-type='method'><a href="module.html#.exports#setCurrentLocale">setCurrentLocale</a></li><li data-type='method'><a href="module.html#.exports#setCustomRpc">setCustomRpc</a></li><li data-type='method'><a href="module.html#.exports#setMsgStatusApproved">setMsgStatusApproved</a></li><li data-type='method'><a href="module.html#.exports#setMsgStatusApproved">setMsgStatusApproved</a></li><li data-type='method'><a href="module.html#.exports#setMsgStatusApproved">setMsgStatusApproved</a></li><li data-type='method'><a href="module.html#.exports#setMsgStatusApproved">setMsgStatusApproved</a></li><li data-type='method'><a href="module.html#.exports#setMsgStatusApproved">setMsgStatusApproved</a></li><li data-type='method'><a href="module.html#.exports#setMsgStatusSigned">setMsgStatusSigned</a></li><li data-type='method'><a href="module.html#.exports#setMsgStatusSigned">setMsgStatusSigned</a></li><li data-type='method'><a href="module.html#.exports#setMsgStatusSigned">setMsgStatusSigned</a></li><li data-type='method'><a href="module.html#.exports#setMsgStatusSigned">setMsgStatusSigned</a></li><li data-type='method'><a href="module.html#.exports#setMsgStatusSigned">setMsgStatusSigned</a></li><li data-type='method'><a href="module.html#.exports#setupControllerConnection">setupControllerConnection</a></li><li data-type='method'><a href="module.html#.exports#setupProviderConnection">setupProviderConnection</a></li><li data-type='method'><a href="module.html#.exports#setupPublicConfig">setupPublicConfig</a></li><li data-type='method'><a href="module.html#.exports#setupTrustedCommunication">setupTrustedCommunication</a></li><li data-type='method'><a href="module.html#.exports#setupUntrustedCommunication">setupUntrustedCommunication</a></li><li data-type='method'><a href="module.html#.exports#setUseBlockie">setUseBlockie</a></li><li data-type='method'><a href="module.html#.exports#signMessage">signMessage</a></li><li data-type='method'><a href="module.html#.exports#signPersonalMessage">signPersonalMessage</a></li><li data-type='method'><a href="module.html#.exports#signTypedMessage">signTypedMessage</a></li><li data-type='method'><a href="module.html#.exports#unlockHardwareWalletAccount">unlockHardwareWalletAccount</a></li><li data-type='method'><a href="module.html#.exports#unMarkPasswordForgotten">unMarkPasswordForgotten</a></li><li data-type='method'><a href="module.html#.exports#validateParams">validateParams</a></li><li data-type='method'><a href="module.html#.exports#verifySeedPhrase">verifySeedPhrase</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="inverted dropdown icon"></i><a href="module.exports_module.exports.html">exports</a></div></div></div></li></div></ul><h3>Modules</h3><ul><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="module-controllers_transactions_lib_recipient-blacklist-checker.html">controllers/transactions/lib/recipient-blacklist-checker</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="module-controllers_transactions_lib_recipient-blacklist-checker.html#~checkAccount">checkAccount</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="module-controllers_transactions_lib_tx-state-history-helper.html">controllers/transactions/lib/tx-state-history-helper</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="module-controllers_transactions_lib_tx-state-history-helper.html#~generateHistoryEntry">generateHistoryEntry</a></li><li data-type='method'><a href="module-controllers_transactions_lib_tx-state-history-helper.html#~migrateFromSnapshotsToDiffs">migrateFromSnapshotsToDiffs</a></li><li data-type='method'><a href="module-controllers_transactions_lib_tx-state-history-helper.html#~replayHistory">replayHistory</a></li><li data-type='method'><a href="module-controllers_transactions_lib_tx-state-history-helper.html#~snapshotFromTxMeta">snapshotFromTxMeta</a></li></ul></div></li></div><div class="ui vertical accordion"><div class="title"><div class="ui list"><div class="item"><i class="dropdown icon"></i><a href="module-controllers_transactions_lib_util.html">controllers/transactions/lib/util</a></div></div></div><div class="content"><ul class='methods'><li data-type='method'><a href="module-controllers_transactions_lib_util.html#~getFinalStates">getFinalStates</a></li><li data-type='method'><a href="module-controllers_transactions_lib_util.html#~normalizeTxParams">normalizeTxParams</a></li><li data-type='method'><a href="module-controllers_transactions_lib_util.html#~validateFrom">validateFrom</a></li><li data-type='method'><a href="module-controllers_transactions_lib_util.html#~validateRecipient">validateRecipient</a></li><li data-type='method'><a href="module-controllers_transactions_lib_util.html#~validateTxParams">validateTxParams</a></li></ul></div></li></div></ul><h3>Global</h3><ul><li><a href="global.html#blacklistedDomainCheck">blacklistedDomainCheck</a></li><li><a href="global.html#BnMultiplyByFraction">BnMultiplyByFraction</a></li><li><a href="global.html#bnToHex">bnToHex</a></li><li><a href="global.html#cleanContextForImports">cleanContextForImports</a></li><li><a href="global.html#cleanErrorStack">cleanErrorStack</a></li><li><a href="global.html#connectToAccountManager">connectToAccountManager</a></li><li><a href="global.html#createLoggerMiddleware">createLoggerMiddleware</a></li><li><a href="global.html#createOriginMiddleware">createOriginMiddleware</a></li><li><a href="global.html#createProviderMiddleware">createProviderMiddleware</a></li><li><a href="global.html#deepMap">deepMap</a></li><li><a href="global.html#doctypeCheck">doctypeCheck</a></li><li><a href="global.html#documentElementCheck">documentElementCheck</a></li><li><a href="global.html#extractEthjsErrorMessage">extractEthjsErrorMessage</a></li><li><a href="global.html#getBuyEthUrl">getBuyEthUrl</a></li><li><a href="global.html#getEnvironmentType">getEnvironmentType</a></li><li><a href="global.html#getFirstPreferredLangCode">getFirstPreferredLangCode</a></li><li><a href="global.html#getObjStructure">getObjStructure</a></li><li><a href="global.html#getPlatform">getPlatform</a></li><li><a href="global.html#getStack">getStack</a></li><li><a href="global.html#hexToBn">hexToBn</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#initializePopup">initializePopup</a></li><li><a href="global.html#initialState">initialState</a></li><li><a href="global.html#isEmpty">isEmpty</a></li><li><a href="global.html#jsonParseStream">jsonParseStream</a></li><li><a href="global.html#jsonStringifyStream">jsonStringifyStream</a></li><li><a href="global.html#loadStateFromPersistence">loadStateFromPersistence</a></li><li><a href="global.html#logStreamDisconnectWarning">logStreamDisconnectWarning</a></li><li><a href="global.html#normalizeMsgData">normalizeMsgData</a></li><li><a href="global.html#redirectToPhishingWarning">redirectToPhishingWarning</a></li><li><a href="global.html#restoreContextAfterImports">restoreContextAfterImports</a></li><li><a href="global.html#setupController">setupController</a></li><li><a href="global.html#setupControllerConnection">setupControllerConnection</a></li><li><a href="global.html#setupInjection">setupInjection</a></li><li><a href="global.html#setupMetamaskMeshMetrics">setupMetamaskMeshMetrics</a></li><li><a href="global.html#setupMultiplex">setupMultiplex</a></li><li><a href="global.html#setupStreams">setupStreams</a></li><li><a href="global.html#setupWeb3Connection">setupWeb3Connection</a></li><li><a href="global.html#shouldInjectWeb3">shouldInjectWeb3</a></li><li><a href="global.html#showWatchAssetUi">showWatchAssetUi</a></li><li><a href="global.html#sufficientBalance">sufficientBalance</a></li><li><a href="global.html#suffixCheck">suffixCheck</a></li><li><a href="global.html#triggerUi">triggerUi</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/personal-message-manager.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const EventEmitter = require('events')
const ObservableStore = require('obs-store')
const ethUtil = require('ethereumjs-util')
const createId = require('./random-id')
const hexRe = /^[0-9A-Fa-f]+$/g
const log = require('loglevel')

/**
 * Represents, and contains data about, an 'personal_sign' type signature request. These are created when a
 * signature for an personal_sign call is requested.
 *
 * @see {@link https://web3js.readthedocs.io/en/1.0/web3-eth-personal.html#sign}
 *
 * @typedef {Object} PersonalMessage
 * @property {number} id An id to track and identify the message object
 * @property {Object} msgParams The parameters to pass to the personal_sign method once the signature request is
 * approved.
 * @property {Object} msgParams.metamaskId Added to msgParams for tracking and identification within MetaMask.
 * @property {string} msgParams.data A hex string conversion of the raw buffer data of the signature request
 * @property {number} time The epoch time at which the this message was created
 * @property {string} status Indicates whether the signature request is 'unapproved', 'approved', 'signed' or 'rejected'
 * @property {string} type The json-prc signing method for which a signature request has been made. A 'Message' will
 * always have a 'personal_sign' type.
 *
 */

module.exports = class PersonalMessageManager extends EventEmitter {
  /**
   * Controller in charge of managing - storing, adding, removing, updating - PersonalMessage.
   *
   * @typedef {Object} PersonalMessageManager
   * @param {Object} opts @deprecated
   * @property {Object} memStore The observable store where PersonalMessage are saved with persistance.
   * @property {Object} memStore.unapprovedPersonalMsgs A collection of all PersonalMessages in the 'unapproved' state
   * @property {number} memStore.unapprovedPersonalMsgCount The count of all PersonalMessages in this.memStore.unapprobedMsgs
   * @property {array} messages Holds all messages that have been created by this PersonalMessageManager
   *
   */
  constructor (opts) {
    super()
    this.memStore = new ObservableStore({
      unapprovedPersonalMsgs: {},
      unapprovedPersonalMsgCount: 0,
    })
    this.messages = []
  }

  /**
   * A getter for the number of 'unapproved' PersonalMessages in this.messages
   *
   * @returns {number} The number of 'unapproved' PersonalMessages in this.messages
   *
   */
  get unapprovedPersonalMsgCount () {
    return Object.keys(this.getUnapprovedMsgs()).length
  }

  /**
   * A getter for the 'unapproved' PersonalMessages in this.messages
   *
   * @returns {Object} An index of PersonalMessage ids to PersonalMessages, for all 'unapproved' PersonalMessages in
   * this.messages
   *
   */
  getUnapprovedMsgs () {
    return this.messages.filter(msg => msg.status === 'unapproved')
    .reduce((result, msg) => { result[msg.id] = msg; return result }, {})
  }

  /**
   * Creates a new PersonalMessage with an 'unapproved' status using the passed msgParams. this.addMsg is called to add
   * the new PersonalMessage to this.messages, and to save the unapproved PersonalMessages from that list to
   * this.memStore.
   *
   * @param {Object} msgParams The params for the eth_sign call to be made after the message is approved.
   * @param {Object} req (optional) The original request object possibly containing the origin
   * @returns {promise} When the message has been signed or rejected
   *
   */
  addUnapprovedMessageAsync (msgParams, req) {
    return new Promise((resolve, reject) => {
      if (!msgParams.from) {
        reject(new Error('MetaMask Message Signature: from field is required.'))
      }
      const msgId = this.addUnapprovedMessage(msgParams, req)
      this.once(`${msgId}:finished`, (data) => {
        switch (data.status) {
          case 'signed':
            return resolve(data.rawSig)
          case 'rejected':
            return reject(new Error('MetaMask Message Signature: User denied message signature.'))
          default:
            return reject(new Error(`MetaMask Message Signature: Unknown problem: ${JSON.stringify(msgParams)}`))
        }
      })
    })
  }

  /**
   * Creates a new PersonalMessage with an 'unapproved' status using the passed msgParams. this.addMsg is called to add
   * the new PersonalMessage to this.messages, and to save the unapproved PersonalMessages from that list to
   * this.memStore.
   *
   * @param {Object} msgParams The params for the eth_sign call to be made after the message is approved.
   * @param {Object} req (optional) The original request object possibly containing the origin
   * @returns {number} The id of the newly created PersonalMessage.
   *
   */
  addUnapprovedMessage (msgParams, req) {
    log.debug(`PersonalMessageManager addUnapprovedMessage: ${JSON.stringify(msgParams)}`)
    // add origin from request
    if (req) msgParams.origin = req.origin
    msgParams.data = this.normalizeMsgData(msgParams.data)
    // create txData obj with parameters and meta data
    var time = (new Date()).getTime()
    var msgId = createId()
    var msgData = {
      id: msgId,
      msgParams: msgParams,
      time: time,
      status: 'unapproved',
      type: 'personal_sign',
    }
    this.addMsg(msgData)

    // signal update
    this.emit('update')
    return msgId
  }

  /**
   * Adds a passed PersonalMessage to this.messages, and calls this._saveMsgList() to save the unapproved PersonalMessages from that
   * list to this.memStore.
   *
   * @param {Message} msg The PersonalMessage to add to this.messages
   *
   */
  addMsg (msg) {
    this.messages.push(msg)
    this._saveMsgList()
  }

  /**
   * Returns a specified PersonalMessage.
   *
   * @param {number} msgId The id of the PersonalMessage to get
   * @returns {PersonalMessage|undefined} The PersonalMessage with the id that matches the passed msgId, or undefined
   * if no PersonalMessage has that id.
   *
   */
  getMsg (msgId) {
    return this.messages.find(msg => msg.id === msgId)
  }

  /**
   * Approves a PersonalMessage. Sets the message status via a call to this.setMsgStatusApproved, and returns a promise
   * with any the message params modified for proper signing.
   *
   * @param {Object} msgParams The msgParams to be used when eth_sign is called, plus data added by MetaMask.
   * @param {Object} msgParams.metamaskId Added to msgParams for tracking and identification within MetaMask.
   * @returns {Promise&lt;object>} Promises the msgParams object with metamaskId removed.
   *
   */
  approveMessage (msgParams) {
    this.setMsgStatusApproved(msgParams.metamaskId)
    return this.prepMsgForSigning(msgParams)
  }

  /**
   * Sets a PersonalMessage status to 'approved' via a call to this._setMsgStatus.
   *
   * @param {number} msgId The id of the PersonalMessage to approve.
   *
   */
  setMsgStatusApproved (msgId) {
    this._setMsgStatus(msgId, 'approved')
  }

  /**
   * Sets a PersonalMessage status to 'signed' via a call to this._setMsgStatus and updates that PersonalMessage in
   * this.messages by adding the raw signature data of the signature request to the PersonalMessage
   *
   * @param {number} msgId The id of the PersonalMessage to sign.
   * @param {buffer} rawSig The raw data of the signature request
   *
   */
  setMsgStatusSigned (msgId, rawSig) {
    const msg = this.getMsg(msgId)
    msg.rawSig = rawSig
    this._updateMsg(msg)
    this._setMsgStatus(msgId, 'signed')
  }

  /**
   * Removes the metamaskId property from passed msgParams and returns a promise which resolves the updated msgParams
   *
   * @param {Object} msgParams The msgParams to modify
   * @returns {Promise&lt;object>} Promises the msgParams with the metamaskId property removed
   *
   */
  prepMsgForSigning (msgParams) {
    delete msgParams.metamaskId
    return Promise.resolve(msgParams)
  }

  /**
   * Sets a PersonalMessage status to 'rejected' via a call to this._setMsgStatus.
   *
   * @param {number} msgId The id of the PersonalMessage to reject.
   *
   */
  rejectMsg (msgId) {
    this._setMsgStatus(msgId, 'rejected')
  }

  /**
   * Updates the status of a PersonalMessage in this.messages via a call to this._updateMsg
   *
   * @private
   * @param {number} msgId The id of the PersonalMessage to update.
   * @param {string} status The new status of the PersonalMessage.
   * @throws A 'PersonalMessageManager - PersonalMessage not found for id: "${msgId}".' if there is no PersonalMessage
   * in this.messages with an id equal to the passed msgId
   * @fires An event with a name equal to `${msgId}:${status}`. The PersonalMessage is also fired.
   * @fires If status is 'rejected' or 'signed', an event with a name equal to `${msgId}:finished` is fired along
   * with the PersonalMessage
   *
   */
  _setMsgStatus (msgId, status) {
    const msg = this.getMsg(msgId)
    if (!msg) throw new Error('PersonalMessageManager - Message not found for id: "${msgId}".')
    msg.status = status
    this._updateMsg(msg)
    this.emit(`${msgId}:${status}`, msg)
    if (status === 'rejected' || status === 'signed') {
      this.emit(`${msgId}:finished`, msg)
    }
  }

  /**
   * Sets a PersonalMessage in this.messages to the passed PersonalMessage if the ids are equal. Then saves the
   * unapprovedPersonalMsgs index to storage via this._saveMsgList
   *
   * @private
   * @param {msg} PersonalMessage A PersonalMessage that will replace an existing PersonalMessage (with the same
   * id) in this.messages
   *
   */
  _updateMsg (msg) {
    const index = this.messages.findIndex((message) => message.id === msg.id)
    if (index !== -1) {
      this.messages[index] = msg
    }
    this._saveMsgList()
  }

  /**
   * Saves the unapproved PersonalMessages, and their count, to this.memStore
   *
   * @private
   * @fires 'updateBadge'
   *
   */
  _saveMsgList () {
    const unapprovedPersonalMsgs = this.getUnapprovedMsgs()
    const unapprovedPersonalMsgCount = Object.keys(unapprovedPersonalMsgs).length
    this.memStore.updateState({ unapprovedPersonalMsgs, unapprovedPersonalMsgCount })
    this.emit('updateBadge')
  }

  /**
   * A helper function that converts raw buffer data to a hex, or just returns the data if it is already formatted as a hex.
   *
   * @param {any} data The buffer data to convert to a hex
   * @returns {string} A hex string conversion of the buffer data
   *
   */
  normalizeMsgData (data) {
    try {
      const stripped = ethUtil.stripHexPrefix(data)
      if (stripped.match(hexRe)) {
        return ethUtil.addHexPrefix(stripped)
      }
    } catch (e) {
      log.debug(`Message was not hex encoded, interpreting as utf8.`)
    }

    return ethUtil.bufferToHex(new Buffer(data, 'utf8'))
  }

}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Sep 12 2018 14:05:44 GMT-0700 (PDT) using the radgrad jsdoc theme. Derived from docdash.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script>$('.ui.accordion').accordion();</script>
</body>
</html>
