import { JsonRpcResponseStruct } from '@metamask/utils';

import { flushPromises } from '../../../../test/lib/timer-helpers';
import { mockBridgeQuotes } from '../../../../test/data/confirmations/contract-interaction';
import { createDappSwapMiddleware } from './dapp-swap-middleware';
import { DappSwapMiddlewareRequest } from './dapp-swap-util';
import _ from 'lodash';

const REQUEST_MOCK = {
  params: [],
  id: '',
  jsonrpc: '2.0' as const,
  origin: 'test.com',
  networkClientId: 'networkClientId',
};

let fetchQuotes = jest.fn();
const setDappSwapComparisonData = jest.fn();
const getNetworkConfigurationByNetworkClientId = jest.fn();

const createMiddleware = (
  args: {
    // eslint-disable-next-line @typescript-eslint/naming-convention
    dappSwapMetricsFlag?: { enabled: boolean; bridge_quote_fees: number };
  } = {},
) => {
  const middlewareFunction = createDappSwapMiddleware({
    fetchQuotes,
    setDappSwapComparisonData,
    getNetworkConfigurationByNetworkClientId,
    // eslint-disable-next-line @typescript-eslint/naming-convention
    dappSwapMetricsFlag: { enabled: true, bridge_quote_fees: 250 },
    ...args,
  });
  return { middlewareFunction };
};

describe('DappSwapMiddleware', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('gets the network configuration for the request networkClientId', async () => {
    const { middlewareFunction } = createMiddleware();

    const req = {
      ...REQUEST_MOCK,
      method: 'eth_sendTransaction',
    };

    await middlewareFunction(
      req,
      { ...JsonRpcResponseStruct.TYPE },
      () => undefined,
    );

    await flushPromises();
  });

  it('does not fetch quotes if dapp swap is not enabled', async () => {
    fetchQuotes.mockReturnValueOnce(mockBridgeQuotes);
    const { middlewareFunction } = createMiddleware({
      // eslint-disable-next-line @typescript-eslint/naming-convention
      dappSwapMetricsFlag: { enabled: false, bridge_quote_fees: 250 },
    });

    const req = {
      ...REQUEST_MOCK,
      method: 'eth_sendTransaction',
      origin: 'https://metamask.github.io',
      securityAlertResponse: {
        securityAlertId: '123',
      },
      params: [
        {
          data: '0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000068f0dd1b0000000000000000000000000000000000000000000000000000000000000003100604000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003070b0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000005af3107a4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e583100000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e58310000000000000000000000007ffc3dbf3b2b50ff3a1d5523bc24bb5043837b1400000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000178239802520a9c99dcbd791f81326b70298d62900000000000000000000000000000000000000000000000000000000000601470c',
          from: '0x12312312312312',
          chainId: '1',
          calls: [],
        },
      ],
      networkClientId: 'networkClientId',
    };

    await middlewareFunction(
      req as unknown as DappSwapMiddlewareRequest<(string | { to: string })[]>,
      { ...JsonRpcResponseStruct.TYPE },
      () => undefined,
    );

    await flushPromises();

    expect(fetchQuotes).not.toHaveBeenCalled();
  });

  it('for correct origin, fetches quotes and sets swap quotes', async () => {
    fetchQuotes.mockReturnValueOnce(mockBridgeQuotes);
    getNetworkConfigurationByNetworkClientId.mockReturnValueOnce({
      chainId: '0x1',
      rpcEndpoints: [],
    });
    const { middlewareFunction } = createMiddleware();

    const req = {
      ...REQUEST_MOCK,
      method: 'eth_sendTransaction',
      origin: 'https://metamask.github.io',
      securityAlertResponse: {
        securityAlertId: '123',
      },
      params: [
        {
          data: '0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000068f0dd1b0000000000000000000000000000000000000000000000000000000000000003100604000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003070b0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000005af3107a4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e583100000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e58310000000000000000000000007ffc3dbf3b2b50ff3a1d5523bc24bb5043837b1400000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000178239802520a9c99dcbd791f81326b70298d62900000000000000000000000000000000000000000000000000000000000601470c',
          from: '0x12312312312312',
          calls: [],
        },
      ],
      networkClientId: 'networkClientId',
    };

    await middlewareFunction(
      req as unknown as DappSwapMiddlewareRequest<(string | { to: string })[]>,
      { ...JsonRpcResponseStruct.TYPE },
      () => undefined,
    );

    await flushPromises();

    expect(fetchQuotes).toHaveBeenCalledWith({
      destChainId: '0x1',
      destTokenAddress: '0xaf88d065e77c8cc2239327c5edb3a432268e5831',
      fee: 250,
      gasIncluded: false,
      gasIncluded7702: false,
      srcChainId: '0x1',
      srcTokenAddress: '0x0000000000000000000000000000000000000000',
      srcTokenAmount: '0x5af3107a4000',
      walletAddress: '0x12312312312312',
    });
  });

  it('capture error and commands if quote fetching fails', async () => {
    fetchQuotes = jest.fn().mockRejectedValue(new Error('fail'));
    getNetworkConfigurationByNetworkClientId.mockReturnValueOnce({
      chainId: '0x1',
      rpcEndpoints: [],
    });
    const { middlewareFunction } = createMiddleware();

    const req = {
      ...REQUEST_MOCK,
      method: 'eth_sendTransaction',
      origin: 'https://metamask.github.io',
      securityAlertResponse: {
        securityAlertId: '123',
      },
      params: [
        {
          data: '0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000068f0dd1b0000000000000000000000000000000000000000000000000000000000000003100604000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003070b0e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000005af3107a4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e583100000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e58310000000000000000000000007ffc3dbf3b2b50ff3a1d5523bc24bb5043837b1400000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000000060000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000178239802520a9c99dcbd791f81326b70298d62900000000000000000000000000000000000000000000000000000000000601470c',
          from: '0x12312312312312',
          calls: [],
        },
      ],
      networkClientId: 'networkClientId',
    };

    await middlewareFunction(
      req as unknown as DappSwapMiddlewareRequest<(string | { to: string })[]>,
      { ...JsonRpcResponseStruct.TYPE },
      () => undefined,
    );

    await flushPromises();

    expect(setDappSwapComparisonData).toHaveBeenCalledWith('123', {
      commands: '0x100604',
      error: 'Error fetching bridge quotes: fail',
    });
  });
});
