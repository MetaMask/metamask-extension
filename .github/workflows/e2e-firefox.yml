name: E2E Firefox

on:
  workflow_call:

jobs:
  test-e2e-firefox:
    uses: ./.github/workflows/run-e2e.yml
    strategy:
      fail-fast: false
      matrix:
        # prettier-ignore
        index: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23]
    with:
      test-suite-name: test-e2e-firefox
      build-command: yarn build:test:mv2
      test-command: yarn test:e2e:firefox
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}

  test-e2e-firefox-flask:
    uses: ./.github/workflows/run-e2e.yml
    strategy:
      fail-fast: false
      matrix:
        index: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
    with:
      test-suite-name: test-e2e-firefox-flask
      build-command: yarn build:test:flask:mv2
      test-command: yarn test:e2e:firefox:flask
      matrix-index: ${{ matrix.index }}
      matrix-total: ${{ strategy.job-total }}

  test-e2e-firefox-report:
    #needs:
    #  - test-e2e-firefox
    #  - test-e2e-firefox-flask
    runs-on: ubuntu-latest
    if: always()
    continue-on-error: true # soft launch
    steps:

      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: false

      - name: Install dependencies for custom reporter
        run: |
          yarn add xml2js glob

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          path: .
          pattern: test-e2e-firefox*
          merge-multiple: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies for custom reporter
        run: |
          yarn add xml2js glob

      - name: Custom Test Report
        id: custom-report
        continue-on-error: true
        run: yarn tsx .github/scripts/parse-test-results.ts

      - name: Test Report (Fallback)
        if: steps.custom-report.outcome == 'failure'
        uses: dorny/test-reporter@6e6a65b7a0bd2c9197df7d0ae36ac5cee784230c
        with:
          name: 'üìù Consolidated Firefox E2E Tests Report'
          path: './test/test-results/e2e/**/*.xml'
          reporter: jest-junit
          fail-on-empty: false
          fail-on-error: false # soft launch
          list-suites: 'failed'
          list-tests: 'failed'
          only-summary: 'false'
          use-actions-summary: 'true'
