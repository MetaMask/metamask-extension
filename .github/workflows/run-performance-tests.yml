name: Performance Tests

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.sha }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  build-test:
    name: Build test extension
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: false
          skip-allow-scripts: true
          use-yarn-hydrate: true

      - name: Build test extension
        run: yarn build:test

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-test-performance
          path: |
            dist/
            builds/

  performance-tests:
    name: Performance Tests
    needs: build-test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: ghcr.io/metamask/metamask-extension-e2e-image:v24.13.0
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      SELENIUM_BROWSER: chrome
      INFURA_PROJECT_ID: ${{ secrets.INFURA_PROJECT_ID }}
      E2E_POWER_USER_SRP: ${{ secrets.E2E_POWER_USER_SRP }}
      TEST_SRP_2: ${{ secrets.TEST_SRP_2 }}
    steps:
      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: false
          skip-allow-scripts: true
          use-yarn-hydrate: true

      - name: Restore .metamask folder
        id: restore-metamask
        uses: actions/cache/restore@v4
        with:
          path: .metamask
          key: .metamask-${{ hashFiles('yarn.lock') }}
          fail-on-cache-miss: false

      - name: Install anvil if cache missed
        if: ${{ steps.restore-metamask.outputs.cache-hit != 'true' }}
        run: yarn mm-foundryup

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-test-performance

      - name: Configure Xvfb
        run: Xvfb -ac :99 -screen 0 1280x1024x16 &

      - name: Run all performance tests
        # Tests run sequentially for accurate timing measurements
        run: yarn test:e2e:performance --retries 1
        timeout-minutes: 30

      - name: Upload test artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: performance-tests-results
          path: |
            ./test-artifacts
            ./test/test-results

      - name: Display performance summary
        if: ${{ !cancelled() }}
        run: |
          echo "ðŸ“Š Performance Test Results"
          echo "=========================="
          if [ -d "./test/test-results/power-user-scenarios" ]; then
            for file in ./test/test-results/power-user-scenarios/*.json; do
              if [ -f "$file" ]; then
                echo ""
                echo "ðŸ“ $(basename "$file")"
                jq -r '.steps[] | "  â±ï¸  \(.name): \(.duration / 1000)s"' "$file" 2>/dev/null || true
                echo "  ðŸ“ˆ Total: $(jq -r '.total' "$file" 2>/dev/null || echo 'N/A')s"
              fi
            done
          else
            echo "No performance results found in ./test/test-results/power-user-scenarios"
          fi
