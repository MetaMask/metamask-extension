name: Nightly Build

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  # Allow manual triggering of the workflow
  workflow_dispatch:

env:
  # For scheduled runs, use the default branch
  BRANCH: ${{ github.ref_name || 'main' }}
  HOST_URL: ${{ vars.AWS_CLOUDFRONT_URL }}/${{ github.event.repository.name }}/${{ github.run_id }}
permissions:
  contents: write
  id-token: write

jobs:
  # Main Chrome build
  build-dist-browserify:
    uses: ./.github/workflows/run-build.yml
    with:
      build-name: build-dist-browserify
      build-command: 'yarn build dist'
    secrets: inherit

  # Main Firefox build
  build-dist-mv2-browserify:
    uses: ./.github/workflows/run-build.yml
    with:
      build-name: build-dist-mv2-browserify
      build-command: 'yarn build dist'
      mozilla-lint: true
      enable-mv3: false
    secrets: inherit

  # Experimental Chrome build
  build-experimental-browserify:
    uses: ./.github/workflows/run-build.yml
    with:
      build-name: build-experimental-browserify
      build-command: 'yarn build --build-type experimental dist'
    secrets: inherit

  # Experimental Firefox build
  build-experimental-mv2-browserify:
    uses: ./.github/workflows/run-build.yml
    with:
      build-name: build-experimental-mv2-browserify
      build-command: 'yarn build --build-type experimental dist'
      mozilla-lint: true
      enable-mv3: false
    secrets: inherit

  post-slack-notification:
    name: Post nightly build notification to Slack
    needs:
      - build-dist-browserify
      - build-dist-mv2-browserify
      - build-experimental-browserify
      - build-experimental-mv2-browserify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: false
          skip-allow-scripts: true
          yarn-custom-url: ${{ vars.YARN_URL }}

      - name: Get package version
        id: package-version
        run: |
          # shellcheck disable=all
          echo "version=$(node -p 'require("./package.json").version')" >> $GITHUB_OUTPUT

      - name: Post to Slack
        env:
          OWNER: ${{ github.repository_owner }}
          REPOSITORY: ${{ github.event.repository.name }}
          BRANCH: ${{ env.BRANCH }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          VERSION: ${{ steps.package-version.outputs.version }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_NIGHTLY_BUILDS_WEBHOOK_URL }}
          DOWNLOAD_URL_CHROME: ${{ env.HOST_URL }}/build-dist-browserify/builds/metamask-chrome-${{ steps.package-version.outputs.version }}.zip
          DOWNLOAD_URL_FIREFOX: ${{ env.HOST_URL }}/build-dist-mv2-browserify/builds/metamask-firefox-${{ steps.package-version.outputs.version }}.zip
          DOWNLOAD_URL_EXPERIMENTAL_CHROME: ${{ env.HOST_URL }}/build-experimental-browserify/builds/metamask-experimental-chrome-${{ steps.package-version.outputs.version }}.zip
          DOWNLOAD_URL_EXPERIMENTAL_FIREFOX: ${{ env.HOST_URL }}/build-experimental-mv2-browserify/builds/metamask-experimental-firefox-${{ steps.package-version.outputs.version }}.zip
        run: yarn tsx .github/scripts/post-nightly-builds.ts
