name: Needs E2E

on:
  workflow_call:
    outputs:
      needs-e2e:
        description: Whether E2E tests are needed
        value: ${{ jobs.needs-e2e.outputs.needs-e2e }}

jobs:
  needs-e2e:
    runs-on: ubuntu-latest
    outputs:
      needs-e2e: ${{ steps.determine.outputs.NEEDS_E2E }}
    env:
      # For a `pull_request` event, the head commit hash is `github.event.pull_request.head.sha`.
      # For a `push` event, the head commit hash is `github.sha`.
      HEAD_COMMIT_HASH: ${{ github.event.pull_request.head.sha || github.sha }}
      # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # OWNER: ${{ github.repository_owner }}
      # REPOSITORY: ${{ github.event.repository.name }}
      # WORKFLOW_ID: main.yml
      # DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Specifying `ref` ensures that the head commit is checked out directly.
          ref: ${{ env.HEAD_COMMIT_HASH }}

      - name: Check skip tag
        id: skip-tag
        run: |
          echo "SKIP=false" >> "$GITHUB_OUTPUT"
          if [[ "${{ github.event_name }}" == "pull_request" ]] || [[ "${{ github.event_name }}" == "merge_group" ]]; then
            if git show --format='%B' --no-patch "${HEAD_COMMIT_HASH}" | grep --fixed-strings --quiet '[skip-e2e]'; then
              echo "SKIP=true" >> "$GITHUB_OUTPUT"
              echo "-> SKIP=true due to [skip-e2e] tag in last commit message"
            fi
          fi

      - name: Check skip label
        id: skip-label
        if: github.event_name == 'pull_request'
        run: |
          echo "SKIP=false" >> "$GITHUB_OUTPUT"
          if gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name' | grep -qx "skip-e2e"; then
            echo "SKIP=true" >> "$GITHUB_OUTPUT"
            echo "-> SKIP=true due to 'skip-e2e' label on PR"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check changed files
        if: steps.skip-tag.outputs.SKIP != 'true' && steps.skip-label.outputs.SKIP != 'true' && (github.event_name == 'pull_request' || github.event_name == 'merge_group')
        # v3.0.2
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        id: changes
        with:
          filters: .github/e2e-filter-rules.yml
          list-files: shell

      - name: Determine if E2E needed
        id: determine
        run: |
          # Default to running E2E tests
          echo "NEEDS_E2E=true" >> "$GITHUB_OUTPUT"

          # Only consider skipping for PRs and merge-queue events
          if [[ "${{ github.event_name }}" == "pull_request" ]] || [[ "${{ github.event_name }}" == "merge_group" ]]; then

            # Skip if [skip e2e] tag found or label exists
            if [[ "${{ steps.skip-tag.outputs.SKIP }}" == "true" ]] || [[ "${{ steps.skip-label.outputs.SKIP }}" == "true" ]]; then
              echo "NEEDS_E2E=false" >> "$GITHUB_OUTPUT"
              if [[ "${{ steps.skip-tag.outputs.SKIP }}" == "true" ]]; then
                echo "-> Skipping E2E tests due to [skip e2e] tag on last commit message"
              else
                echo "-> Skipping E2E tests due to 'skip e2e' label on PR"
              fi

            # Skip if no files requiring E2E were changed
            elif [[ "${{ steps.changes.outputs.files-e2e-required }}" == "false" ]]; then
              echo "NEEDS_E2E=false" >> "$GITHUB_OUTPUT"
              echo "-> Skipping E2E tests - only non-code files changed"

            else
              echo "-> Running E2E tests - code files were changed"
            fi

          else
            # For all other events (push, schedule, etc.), always run E2E
            echo "-> Always run E2E tests for ${{ github.event_name }} events"
          fi

      # Prep E2E steps - only run if E2E is needed and not on stable branch
      # - name: Run git diff script
      #   if: |
      #     steps.determine.outputs.NEEDS_E2E == 'true' &&
      #     github.event_name == 'pull_request' &&
      #     github.head_ref != 'stable'
      #   run: |
      #     # Install minimal deps for git-diff script
      #     npm install --no-save @actions/core @actions/github
      #     npx tsx .github/scripts/git-diff-default-branch.ts

      # - name: Upload changed files artifact
      #   if: |
      #     steps.determine.outputs.NEEDS_E2E == 'true' &&
      #     github.head_ref != 'stable'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: changed-files
      #     path: ./changed-files/

      # - name: Run E2E Page Object Usage Validation
      #   if: |
      #     steps.determine.outputs.NEEDS_E2E == 'true' &&
      #     github.head_ref != 'stable'
      #   run: |
      #     npm install --no-save @actions/core
      #     npx tsx .github/scripts/validate-e2e-page-object-usage.ts

      # - name: Get last completed main workflow
      #   if: |
      #     steps.determine.outputs.NEEDS_E2E == 'true' &&
      #     github.head_ref != 'stable'
      #   id: get-last-completed-main-workflow
      #   run: |
      #     last_completed_main_workflow=$(gh api \
      #       "/repos/${OWNER}/${REPOSITORY}/actions/workflows/${WORKFLOW_ID}/runs?branch=${DEFAULT_BRANCH}&per_page=1&status=success" \
      #       --jq '.workflow_runs[0].id')
      #     echo "LAST_COMPLETED_MAIN_WORKFLOW=$last_completed_main_workflow" >> "$GITHUB_OUTPUT"

      # - name: Download test-e2e-chrome-report
      #   if: |
      #     steps.determine.outputs.NEEDS_E2E == 'true' &&
      #     github.head_ref != 'stable' &&
      #     steps.get-last-completed-main-workflow.outputs.LAST_COMPLETED_MAIN_WORKFLOW != 'null'
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: test-e2e-chrome-report
      #     path: test/test-results/
      #     github-token: ${{ env.GITHUB_TOKEN }}
      #     run-id: ${{ steps.get-last-completed-main-workflow.outputs.LAST_COMPLETED_MAIN_WORKFLOW }}

      # - name: Download test-e2e-firefox-report
      #   if: |
      #     steps.determine.outputs.NEEDS_E2E == 'true' &&
      #     github.head_ref != 'stable' &&
      #     steps.get-last-completed-main-workflow.outputs.LAST_COMPLETED_MAIN_WORKFLOW != 'null'
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: test-e2e-firefox-report
      #     path: test/test-results/
      #     github-token: ${{ env.GITHUB_TOKEN }}
      #     run-id: ${{ steps.get-last-completed-main-workflow.outputs.LAST_COMPLETED_MAIN_WORKFLOW }}

      # - name: Upload test-runs-for-splitting
      #   if: |
      #     steps.determine.outputs.NEEDS_E2E == 'true' &&
      #     github.head_ref != 'stable' &&
      #     steps.get-last-completed-main-workflow.outputs.LAST_COMPLETED_MAIN_WORKFLOW != 'null'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: test-runs-for-splitting
      #     path: test/test-results/test-runs-*.json
