on:
  workflow_call:
    inputs:
      builds-from-run:
        required: true
        type: string
        description: The run ID to get builds from
    secrets:
      INFURA_PROJECT_ID:
        required: true

env:
  COMMANDS: |
    {
      standardHome: 'yarn tsx test/e2e/benchmarks/benchmark.ts --out test-artifacts/benchmarks/benchmark-{0}-{1}-standardHome.json --retries 2',
      powerUserHome: 'yarn tsx test/e2e/benchmarks/benchmark.ts --persona powerUser --browserLoads 10 --pageLoads 10 --out test-artifacts/benchmarks/benchmark-{0}-{1}-powerUserHome.json --retries 2',
      userActions: 'yarn tsx test/e2e/benchmarks/user-actions-benchmark.ts --out test-artifacts/benchmarks/benchmark-{0}-{1}-userActions.json --retries 2',
    }

jobs:
  benchmarks:
    if: ${{ github.event_name != 'merge_group' }} # Skip this job for the Merge Queue
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: ghcr.io/metamask/metamask-extension-e2e-image:v24.11.0
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox]
        buildType: [browserify, webpack]
        pageType: [standardHome, powerUserHome, userActions]
    name: ${{ matrix.browser }}-${{ matrix.buildType }}-${{ matrix.pageType }}
    env:
      SELENIUM_BROWSER: ${{ matrix.browser }}
      HEADLESS: false
      ARTIFACT_NAME: build-test${{ matrix.browser == 'firefox' && '-mv2' || '' }}-${{ matrix.buildType }}
      OUTPUT_NAME: benchmark-${{ matrix.browser }}-${{ matrix.buildType }}-${{ matrix.pageType }}.json
      INFURA_PROJECT_ID: ${{ secrets.INFURA_PROJECT_ID }}
      SENTRY_DSN_PERFORMANCE: ${{ vars.SENTRY_DSN_PERFORMANCE }}
    continue-on-error: true
    steps:
      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: false
          skip-allow-scripts: true
          use-yarn-hydrate: true

      - name: Restore .metamask folder
        id: restore-metamask
        uses: actions/cache/restore@v4
        with:
          path: .metamask
          key: .metamask-${{ hashFiles('yarn.lock') }}
          fail-on-cache-miss: false

      - name: Install anvil if cache missed
        if: ${{ steps.restore-metamask.outputs.cache-hit != 'true'}}
        run: yarn mm-foundryup

      - name: Download artifact '${{ env.ARTIFACT_NAME }}'
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          github-token: ${{ secrets.GITHUB_TOKEN }} # This is required when downloading artifacts from a different repository or from a different workflow run.
          run-id: ${{ inputs.builds-from-run }} # Download from whatever run the identify-builds job said.

      - name: Configure Xvfb
        run: Xvfb -ac :99 -screen 0 1280x1024x16 &

      # TODO: Pre-install this in the container image
      - name: Install AWS CLI (needed in the container)
        run: sudo apt-get update && sudo apt-get install python3-pip && sudo pip install awscli --break-system-packages

      - name: Run the benchmark
        # Choose a benchmark command from env.COMMANDS
        # Then replace the {0} placeholder with the browser, and the {1} placeholder with the buildType
        run: ${{ format(fromJson(env.COMMANDS)[matrix.pageType], matrix.browser, matrix.buildType) }}

      - name: Upload '${{ env.OUTPUT_NAME }}' to S3
        if: ${{ vars.AWS_REGION && vars.AWS_IAM_ROLE && vars.AWS_S3_BUCKET }}
        uses: MetaMask/github-tools/.github/actions/upload-s3@v1
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ vars.AWS_IAM_ROLE }}
          s3-bucket: ${{ vars.AWS_S3_BUCKET }}/${{ github.event.repository.name }}/${{ github.run_id }}/benchmarks/${{ env.OUTPUT_NAME }}
          path: test-artifacts/benchmarks/${{ env.OUTPUT_NAME }}
