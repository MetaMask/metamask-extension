name: Update LavaMoat policies

on:
  issue_comment:
    types: created

env:
  INFURA_PROJECT_ID: 00000000000
  INFURA_PROD_PROJECT_ID: 00000000000
  SEGMENT_PROD_WRITE_KEY: 00000000000
  GOOGLE_PROD_CLIENT_ID: 00000000000
  APPLE_PROD_CLIENT_ID: 00000000000
  GOOGLE_BETA_CLIENT_ID: 00000000000
  APPLE_BETA_CLIENT_ID: 00000000000
  GOOGLE_EXPERIMENTAL_CLIENT_ID: 00000000000
  APPLE_EXPERIMENTAL_CLIENT_ID: 00000000000
  GOOGLE_FLASK_CLIENT_ID: 00000000000
  APPLE_FLASK_CLIENT_ID: 00000000000

jobs:
  prepare:
    name: Prepare dependencies
    # Only run when the comment is on a pull request containing '@metamaskbot update-policies'
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '@metamaskbot update-policies') }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      GITHUB_TOKEN: ${{ secrets.LAVAMOAT_UPDATE_TOKEN }}
      REPO: ${{ github.repository }}
      PR_NUMBER: ${{ github.event.issue.number }}
      COMMENT_ID: ${{ github.event.comment.id }}
    outputs:
      IS_FORK: ${{ steps.is-fork.outputs.IS_FORK }}
      COMMIT_SHA: ${{ steps.commit-sha.outputs.COMMIT_SHA }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine whether this PR is from a fork
        id: is-fork
        run: echo "IS_FORK=$(gh pr view --json isCrossRepository --jq '.isCrossRepository' "${PR_NUMBER}" )" >> "$GITHUB_OUTPUT"

      - name: React to the comment
        if: ${{ steps.is-fork.outputs.IS_FORK == 'false' }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${REPO}/issues/comments/${COMMENT_ID}/reactions" \
            -f content='+1'

      - name: Checkout pull request
        if: ${{ steps.is-fork.outputs.IS_FORK == 'false' }}
        run: gh pr checkout "${PR_NUMBER}"

      - name: Checkout and setup environment
        if: ${{ steps.is-fork.outputs.IS_FORK == 'false' }}
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: false
          cache-node-modules: true
          skip-allow-scripts: true
          use-yarn-hydrate: true

      - name: Get commit SHA
        if: ${{ steps.is-fork.outputs.IS_FORK == 'false' }}
        id: commit-sha
        run: echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

  update-lavamoat-build-policy:
    name: Update LavaMoat build policy
    needs:
      - prepare
    if: ${{ needs.prepare.outputs.IS_FORK == 'false' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      GITHUB_TOKEN: ${{ secrets.LAVAMOAT_UPDATE_TOKEN }}
      PR_NUMBER: ${{ github.event.issue.number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout pull request
        run: gh pr checkout "${PR_NUMBER}"

      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: false
          skip-allow-scripts: true
          use-yarn-hydrate: true

      - name: Update LavaMoat build policy
        run: yarn lavamoat:build:auto

      - name: Cache build policy
        uses: actions/cache/save@v4
        with:
          path: lavamoat/build-system
          key: cache-build-${{ needs.prepare.outputs.COMMIT_SHA }}

  update-lavamoat-webapp-policy:
    name: Update LavaMoat webapp policy
    needs:
      - prepare
      - update-lavamoat-build-policy
    if: ${{ needs.prepare.outputs.IS_FORK == 'false' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      GITHUB_TOKEN: ${{ secrets.LAVAMOAT_UPDATE_TOKEN }}
      PR_NUMBER: ${{ github.event.issue.number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout pull request
        run: gh pr checkout "${PR_NUMBER}"

      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: false
          skip-allow-scripts: true
          use-yarn-hydrate: true

      - name: Restore build policy
        uses: actions/cache/restore@v4
        with:
          path: lavamoat/build-system
          key: cache-build-${{ needs.prepare.outputs.COMMIT_SHA }}
          fail-on-cache-miss: true

      - name: Update LavaMoat webapp policy
        run: yarn lavamoat:webapp:auto

      - name: Cache webapp application policy
        uses: actions/cache/save@v4
        with:
          path: lavamoat/browserify
          key: cache-webapp-${{ needs.prepare.outputs.COMMIT_SHA }}

  update-lavamoat-webpack-policy-build:
    name: Update LavaMoat webpack build policy
    needs:
      - prepare
    if: ${{ needs.prepare.outputs.IS_FORK == 'false' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      GITHUB_TOKEN: ${{ secrets.LAVAMOAT_UPDATE_TOKEN }}
      PR_NUMBER: ${{ github.event.issue.number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout pull request
        run: gh pr checkout "${PR_NUMBER}"

      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: false
          skip-allow-scripts: true
          use-yarn-hydrate: true

      - name: Update LavaMoat webpack build policy
        run: yarn webpack:tsc && yarn webpack:lavamoat:policy:build

      - name: Cache webpack build policy
        uses: actions/cache/save@v4
        with:
          path: lavamoat/webpack/build
          key: cache-webpack-build-${{ needs.prepare.outputs.COMMIT_SHA }}

  update-lavamoat-webpack-policy-mv2:
    name: Update LavaMoat webpack MV2 policy
    needs:
      - prepare
      - update-lavamoat-webpack-policy-build
    if: ${{ needs.prepare.outputs.IS_FORK == 'false' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      GITHUB_TOKEN: ${{ secrets.LAVAMOAT_UPDATE_TOKEN }}
      PR_NUMBER: ${{ github.event.issue.number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout pull request
        run: gh pr checkout "${PR_NUMBER}"

      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: false
          skip-allow-scripts: true
          use-yarn-hydrate: true

      - name: Restore webpack build policy
        uses: actions/cache/restore@v4
        with:
          path: lavamoat/webpack/build
          key: cache-webpack-build-${{ needs.prepare.outputs.COMMIT_SHA }}
          fail-on-cache-miss: true

      - name: Update LavaMoat webpack MV2 policy
        run: yarn webpack:tsc && yarn webpack:lavamoat:policy:mv2

      - name: Cache webpack MV2 policy
        uses: actions/cache/save@v4
        with:
          path: lavamoat/webpack/mv2
          key: cache-webpack-mv2-${{ needs.prepare.outputs.COMMIT_SHA }}

  update-lavamoat-webpack-policy-mv3:
    name: Update LavaMoat webpack MV3 policy
    needs:
      - prepare
      - update-lavamoat-webpack-policy-build
    if: ${{ needs.prepare.outputs.IS_FORK == 'false' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      GITHUB_TOKEN: ${{ secrets.LAVAMOAT_UPDATE_TOKEN }}
      PR_NUMBER: ${{ github.event.issue.number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout pull request
        run: gh pr checkout "${PR_NUMBER}"

      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: false
          skip-allow-scripts: true
          use-yarn-hydrate: true

      - name: Restore webpack build policy
        uses: actions/cache/restore@v4
        with:
          path: lavamoat/webpack/build
          key: cache-webpack-build-${{ needs.prepare.outputs.COMMIT_SHA }}
          fail-on-cache-miss: true

      - name: Update LavaMoat webpack MV3 policy
        run: yarn webpack:tsc && yarn webpack:lavamoat:policy:mv3

      - name: Cache webpack MV3 policy
        uses: actions/cache/save@v4
        with:
          path: lavamoat/webpack/mv3
          key: cache-webpack-mv3-${{ needs.prepare.outputs.COMMIT_SHA }}

  commit-updated-policies:
    name: Commit the updated LavaMoat policies
    needs:
      - prepare
      - update-lavamoat-build-policy
      - update-lavamoat-webapp-policy
      - update-lavamoat-webpack-policy-build
      - update-lavamoat-webpack-policy-mv2
      - update-lavamoat-webpack-policy-mv3
    if: ${{ needs.prepare.outputs.IS_FORK == 'false' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      GITHUB_TOKEN: ${{ secrets.LAVAMOAT_UPDATE_TOKEN }}
      PR_NUMBER: ${{ github.event.issue.number }}
      ACTION_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use PAT to ensure that the commit later can trigger status check workflows
          token: ${{ secrets.LAVAMOAT_UPDATE_TOKEN }}

      - name: Checkout pull request
        run: gh pr checkout "${PR_NUMBER}"

      - name: Restore browserify build policy
        uses: actions/cache/restore@v4
        with:
          path: lavamoat/build-system
          key: cache-build-${{ needs.prepare.outputs.COMMIT_SHA }}
          fail-on-cache-miss: true

      - name: Restore browserify webapp policy
        uses: actions/cache/restore@v4
        with:
          path: lavamoat/browserify
          key: cache-webapp-${{ needs.prepare.outputs.COMMIT_SHA }}
          fail-on-cache-miss: true

      - name: Restore webpack build policy
        uses: actions/cache/restore@v4
        with:
          path: lavamoat/webpack/build
          key: cache-webpack-build-${{ needs.prepare.outputs.COMMIT_SHA }}
          fail-on-cache-miss: true

      - name: Restore webpack MV2 policy
        uses: actions/cache/restore@v4
        with:
          path: lavamoat/webpack/mv2
          key: cache-webpack-mv2-${{ needs.prepare.outputs.COMMIT_SHA }}
          fail-on-cache-miss: true

      - name: Restore webpack MV3 policy
        uses: actions/cache/restore@v4
        with:
          path: lavamoat/webpack/mv3
          key: cache-webpack-mv3-${{ needs.prepare.outputs.COMMIT_SHA }}
          fail-on-cache-miss: true

      - name: Check whether there are policy changes
        id: policy-changes
        run: |
          if git diff --exit-code
          then
            echo "HAS_CHANGES=false" >> "$GITHUB_OUTPUT"
          else
            echo "HAS_CHANGES=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit the updated policies
        if: ${{ steps.policy-changes.outputs.HAS_CHANGES == 'true' }}
        run: |
          git config --global user.name 'MetaMask Bot'
          git config --global user.email 'metamaskbot@users.noreply.github.com'
          git commit -am "Update LavaMoat policies"
          git push

      ## Yes, it would be nice to use the local diff before the commit is made, but we need to include potential multiple updates in the history of the PR
      - name: Compare policy changes
        run: |
          if [[ $HAS_CHANGES == 'true' ]]
          then
            git fetch origin ${{ github.base_ref }}
            main_diff=$(git diff origin/${{ github.base_ref }} lavamoat/browserify/main/policy.json | md5sum | cut -d' ' -f1)
            for folder in lavamoat/browserify/*/; do
              if [ "$folder" != "lavamoat/browserify/main/" ]; then
                file="${folder}policy.json"
                if [ -f "$file" ]; then
                  diff=$(git diff origin/${{ github.base_ref }} "$file" | md5sum | cut -d' ' -f1)
                  if [ "$diff" = "$main_diff" ]; then
                    echo "âœ… ${folder}policy.json changes match main/policy.json policy changes"
                  else
                    echo "ðŸ‘€ ${folder}policy.json changes **differ from** main/policy.json policy changes"
                  fi
                fi
              fi
            done > does_diff_diff.txt
          fi

      ## Note the use of `cat -` to include the file contents and the echo in the comment
      - name: Post comment
        run: |
          if [[ $HAS_CHANGES == 'true' ]]
          then
            echo -e 'Policies updated.  \nðŸ‘€ Please review the diff for suspicious new powers.  \n\nðŸ§  Learn how: https://lavamoat.github.io/guides/policy-diff/#what-to-look-for-when-reviewing-a-policy-diff \n\n' | cat - does_diff_diff.txt |  gh pr comment "${PR_NUMBER}" --body-file -
          else
            gh pr comment "${PR_NUMBER}" --body 'No policy changes'
          fi
        env:
          HAS_CHANGES: ${{ steps.policy-changes.outputs.HAS_CHANGES }}

      - name: Post comment if the update failed
        if: ${{ failure() }}
        run: |
          gh pr comment "${PR_NUMBER}" --body "Policy update failed. You can [review the logs or retry the policy update here](${ACTION_RUN_URL})"
