name: Tag Release Branch

on:
  workflow_dispatch:
    inputs:
      release-branch:
        description: 'Release branch including version (e.g., release/12.0.0)'
        required: true
        type: string
      force-retag:
        description: 'Force re-tag if tag already exists (only if no GitHub release)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  statuses: write

jobs:
  tag-release-branch:
    name: Tag Release Branch HEAD
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Restrict to users with write access (release team members)
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'
    outputs:
      release-branch: ${{ steps.determine-branch.outputs.branch }}
      # Only one of tag-release or existing-tag-output steps will run based on needs_retag condition
      # The || operator ensures we get the output from whichever step executed
      tag-name: ${{ steps.tag-release.outputs.tag || steps.existing-tag-output.outputs.tag }}
      flask-tag-name: ${{ steps.tag-release.outputs.flask_tag || steps.existing-tag-output.outputs.flask_tag }}
      tag-sha: ${{ steps.tag-release.outputs.sha || steps.existing-tag-output.outputs.sha }}
    steps:
      - name: Determine release branch
        id: determine-branch
        env:
          PROVIDED_BRANCH: ${{ inputs.release-branch }}
        run: |
          # Set working branch variable
          BRANCH="${PROVIDED_BRANCH}"

          # Extract version from branch name (supports Version-vX.Y.Z or release/X.Y.Z)
          SEMVER_PATTERN='[0-9]+\.[0-9]+\.[0-9]+'
          if [[ "${BRANCH}" =~ ^Version-v(${SEMVER_PATTERN})$ ]] || [[ "${BRANCH}" =~ ^release/(${SEMVER_PATTERN})$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "::error::Could not extract version from branch name: ${BRANCH}"
            echo "::error::Expected 'Version-vX.Y.Z' or 'release/X.Y.Z'"
            exit 1
          fi

          {
            echo "branch=${BRANCH}"
            echo "version=${VERSION}"
          } >> "${GITHUB_OUTPUT}"
          echo "Using release branch: ${BRANCH}"
          echo "Using version: ${VERSION}"

      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.determine-branch.outputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Handle existing tag
        id: check-existing-tag
        env:
          VERSION: ${{ steps.determine-branch.outputs.version }}
          FORCE_RETAG: ${{ inputs.force-retag }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="v${VERSION}"
          FLASK_TAG_NAME="v${VERSION}-flask.0"
          HEAD_SHA=$(git rev-parse HEAD)
          # While shell scripts use exit codes (0=true, non-zero=false) for boolean logic,
          # we use string values ("true"/"false") here for readability and explicit state tracking
          needs_retag="false"
          needs_flask_retag="false"

          # Check main tag
          if git rev-parse "${TAG_NAME}" >/dev/null 2>&1; then
            echo "Tag ${TAG_NAME} already exists"

            # Check if there's a GitHub release for this tag
            if gh release view "${TAG_NAME}" >/dev/null 2>&1; then
              echo "::error::Tag ${TAG_NAME} has an associated GitHub release and cannot be moved."
              echo "::error::This release appears to be finalized. Create a new patch version instead."
              exit 1
            fi

            # Get existing tag SHA
            TAG_SHA=$(git rev-parse "${TAG_NAME}")

            if [[ "${TAG_SHA}" == "${HEAD_SHA}" ]]; then
              echo "Main tag already points to current HEAD."
            elif [[ "${FORCE_RETAG}" == "true" ]]; then
              echo "Main tag exists at different commit. Force re-tag is enabled."
              echo "Will move tag from ${TAG_SHA:0:7} to ${HEAD_SHA:0:7}"

              # Delete the old tag (local and remote)
              git tag -d "${TAG_NAME}"
              git push origin ":refs/tags/${TAG_NAME}"

              needs_retag="true"
              echo "Old main tag deleted. Will create new tag at HEAD."
            else
              echo "::error::Tag ${TAG_NAME} exists but not at HEAD."
              echo "::error::To move the tag, run this workflow again with 'force-retag' enabled."
              # Log debug details to stderr (for logs) but not as GitHub error annotation (::error::)
              echo "Debug: Tag is at ${TAG_SHA:0:7}, HEAD is at ${HEAD_SHA:0:7}" >&2
              exit 1
            fi
          else
            echo "Main tag does not exist yet. Will create it."
            needs_retag="true"
          fi

          # Check Flask tag
          if git rev-parse "${FLASK_TAG_NAME}" >/dev/null 2>&1; then
            echo "Flask tag ${FLASK_TAG_NAME} already exists"

            # Get existing Flask tag SHA
            FLASK_TAG_SHA=$(git rev-parse "${FLASK_TAG_NAME}")

            if [[ "${FLASK_TAG_SHA}" == "${HEAD_SHA}" ]]; then
              echo "Flask tag already points to current HEAD."
            elif [[ "${FORCE_RETAG}" == "true" ]]; then
              echo "Flask tag exists at different commit. Force re-tag is enabled."
              echo "Will move Flask tag from ${FLASK_TAG_SHA:0:7} to ${HEAD_SHA:0:7}"

              # Delete the old Flask tag (local and remote)
              git tag -d "${FLASK_TAG_NAME}"
              git push origin ":refs/tags/${FLASK_TAG_NAME}"

              needs_flask_retag="true"
              echo "Old Flask tag deleted. Will create new Flask tag at HEAD."
            else
              echo "::error::Flask tag ${FLASK_TAG_NAME} exists but not at HEAD."
              echo "::error::To move the tag, run this workflow again with 'force-retag' enabled."
              # Log debug details to stderr (for logs) but not as GitHub error annotation (::error::)
              echo "Debug: Flask tag is at ${FLASK_TAG_SHA:0:7}, HEAD is at ${HEAD_SHA:0:7}" >&2
              exit 1
            fi
          else
            echo "Flask tag does not exist yet. Will create it."
            needs_flask_retag="true"
          fi

          # Set output based on whether we need to create/update any tags
          if [[ "${needs_retag}" == "true" ]] || [[ "${needs_flask_retag}" == "true" ]]; then
            {
              echo "needs_retag=true"
              echo "needs_main_tag=${needs_retag}"
              echo "needs_flask_tag=${needs_flask_retag}"
            } >> "${GITHUB_OUTPUT}"
          else
            {
              echo "needs_retag=false"
              echo "needs_main_tag=false"
              echo "needs_flask_tag=false"
            } >> "${GITHUB_OUTPUT}"
            echo "No action needed for tags."
          fi

      - name: Create or update release tag
        id: tag-release
        if: steps.check-existing-tag.outputs.needs_retag != 'false'
        env:
          VERSION: ${{ steps.determine-branch.outputs.version }}
          NEEDS_MAIN_TAG: ${{ steps.check-existing-tag.outputs.needs_main_tag }}
          NEEDS_FLASK_TAG: ${{ steps.check-existing-tag.outputs.needs_flask_tag }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="v${VERSION}"
          FLASK_TAG_NAME="v${VERSION}-flask.0"

          # Configure git
          git config user.email "metamaskbot@users.noreply.github.com"
          git config user.name "MetaMask Bot"

          # Get the current SHA
          SHA=$(git rev-parse HEAD)

          # Create main tag if needed
          if [[ "${NEEDS_MAIN_TAG}" == "true" ]]; then
            git tag -a "${TAG_NAME}" -m "Release ${VERSION}"
            git push origin "${TAG_NAME}"
            echo "Created and pushed main tag: ${TAG_NAME} at ${SHA}"
          else
            echo "Main tag already exists at HEAD, skipping."
          fi

          # Create Flask tag if needed
          if [[ "${NEEDS_FLASK_TAG}" == "true" ]]; then
            git tag -a "${FLASK_TAG_NAME}" -m "Flask version ${VERSION}-flask.0"
            git push origin "${FLASK_TAG_NAME}"
            echo "Created and pushed Flask tag: ${FLASK_TAG_NAME} at ${SHA}"
          else
            echo "Flask tag already exists at HEAD, skipping."
          fi

          {
            echo "tag=${TAG_NAME}"
            echo "flask_tag=${FLASK_TAG_NAME}"
            echo "sha=${SHA}"
          } >> "${GITHUB_OUTPUT}"

      - name: Set output for existing tag
        id: existing-tag-output
        if: steps.check-existing-tag.outputs.needs_retag == 'false'
        env:
          VERSION: ${{ steps.determine-branch.outputs.version }}
        run: |
          TAG_NAME="v${VERSION}"
          FLASK_TAG_NAME="v${VERSION}-flask.0"
          SHA=$(git rev-parse HEAD)
          {
            echo "tag=${TAG_NAME}"
            echo "flask_tag=${FLASK_TAG_NAME}"
            echo "sha=${SHA}"
          } >> "${GITHUB_OUTPUT}"

      - name: Set status check on release branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_SHA: ${{ steps.tag-release.outputs.sha || steps.existing-tag-output.outputs.sha }}
          TAG_NAME: ${{ steps.tag-release.outputs.tag || steps.existing-tag-output.outputs.tag }}
        run: |
          # Set a successful status check to indicate the release has been tagged
          gh api \
            --method POST \
            -H "Accept: application/vnd.github.v3+json" \
            "/repos/${{ github.repository }}/statuses/${TAG_SHA}" \
            -f state='success' \
            -f target_url="${{ github.server_url }}/${{ github.repository }}/releases/tag/${TAG_NAME}" \
            -f description='Release has been tagged' \
            -f context='release/tagged'
