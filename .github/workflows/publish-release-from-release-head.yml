name: Publish Release from Release HEAD

# This workflow publishes a production release from the HEAD of a release/X.Y.Z branch.
# It ensures the invariant: Tag SHA == Build SHA == GitHub Release target SHA == release branch HEAD.
#
# Usage:
#   1. Navigate to Actions > "Publish Release from Release HEAD"
#   2. Click "Run workflow"
#   3. Select the release/X.Y.Z branch from the dropdown
#
# Prerequisites:
#   - Release-team membership is verified before any job runs
#   - CI checks must have passed on the release branch HEAD
#   - The workflow must be run from a release/X.Y.Z branch

on:
  workflow_dispatch:

permissions:
  contents: write # Required to push tags and create releases
  checks: read # Required to verify CI check-runs on the SHA

jobs:
  verify-release-team:
    name: Verify release-team membership
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Confirm release-team membership
        uses: TheModdingInquisition/actions-team-membership@057d91bb80f2976a1bc6dfab5b4ae1da9aebbd89
        with:
          token: ${{ secrets.METAMASK_EXTENSION_ORG_READ_TOKEN }}
          team: release-team
          organization: MetaMask
          exit: true

  validate-branch:
    name: Validate release branch
    needs: verify-release-team
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      version: ${{ steps.extract-semver.outputs.semver }}
      tag: ${{ steps.compute-tag.outputs.tag }}
      release-sha: ${{ steps.compute-tag.outputs.release_sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false

      - name: Extract and validate semver from branch
        id: extract-semver
        run: .github/scripts/extract-semver.sh

      - name: Compute tag and release SHA
        id: compute-tag
        env:
          VERSION: ${{ steps.extract-semver.outputs.semver }}
          RELEASE_SHA: ${{ github.sha }}
        run: |
          TAG="v${VERSION}"
          echo "Validated release branch:"
          echo "  Version: ${VERSION}"
          echo "  Tag: ${TAG}"
          echo "  SHA: ${RELEASE_SHA}"

          {
            echo "tag=${TAG}"
            echo "release_sha=${RELEASE_SHA}"
          } >> "${GITHUB_OUTPUT}"

      - name: Summary
        env:
          VERSION: ${{ steps.extract-semver.outputs.semver }}
          TAG: ${{ steps.compute-tag.outputs.tag }}
          RELEASE_SHA: ${{ steps.compute-tag.outputs.release_sha }}
        run: |
          {
            echo "## Release Branch Validation"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| Version | \`${VERSION}\` |"
            echo "| Tag | \`${TAG}\` |"
            echo "| SHA | \`${RELEASE_SHA}\` |"
          } >> "${GITHUB_STEP_SUMMARY}"

  verify-ci-checks:
    name: Verify CI checks passed
    needs: validate-branch
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-branch.outputs.release-sha }}
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false

      - name: Verify required CI checks
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_SHA: ${{ needs.validate-branch.outputs.release-sha }}
        run: .github/scripts/verify-ci-checks.sh

      - name: Summary
        if: always()
        env:
          RELEASE_SHA: ${{ needs.validate-branch.outputs.release-sha }}
        run: |
          {
            echo "## CI Check Verification"
            echo ""
            echo "Verified \`all-jobs-pass\` on SHA: \`${RELEASE_SHA}\`"
            echo ""
            echo "This check gates all CI jobs including:"
            echo "- Unit tests, linting, builds"
            echo "- E2E tests (Chrome & Firefox)"
            echo "- All other required checks"
          } >> "${GITHUB_STEP_SUMMARY}"

  # Production builds - 4 variants required for release
  # These use 'yarn build prod' (not 'yarn build dist') to match stable branch builds

  build-dist-browserify:
    name: Build prod (Chrome MV3)
    needs:
      - validate-branch
      - verify-ci-checks
    uses: ./.github/workflows/run-build.yml
    with:
      build-name: build-dist-browserify
      build-command: yarn build prod
      builds-from-run: ${{ github.run_id }}
    secrets: inherit

  build-dist-mv2-browserify:
    name: Build prod (Firefox MV2)
    needs:
      - validate-branch
      - verify-ci-checks
    uses: ./.github/workflows/run-build.yml
    with:
      build-name: build-dist-mv2-browserify
      build-command: yarn build prod
      mozilla-lint: true
      enable-mv3: false
      builds-from-run: ${{ github.run_id }}
    secrets: inherit

  build-flask-browserify:
    name: Build Flask prod (Chrome MV3)
    needs:
      - validate-branch
      - verify-ci-checks
    uses: ./.github/workflows/run-build.yml
    with:
      build-name: build-flask-browserify
      build-command: yarn build --build-type flask prod
      builds-from-run: ${{ github.run_id }}
    secrets: inherit

  build-flask-mv2-browserify:
    name: Build Flask prod (Firefox MV2)
    needs:
      - validate-branch
      - verify-ci-checks
    uses: ./.github/workflows/run-build.yml
    with:
      build-name: build-flask-mv2-browserify
      build-command: yarn build --build-type flask prod
      mozilla-lint: true
      enable-mv3: false
      builds-from-run: ${{ github.run_id }}
    secrets: inherit

  publish-release:
    name: Publish release
    needs:
      - validate-branch
      - build-dist-browserify
      - build-dist-mv2-browserify
      - build-flask-browserify
      - build-flask-mv2-browserify
    runs-on: ubuntu-latest
    # Grant access to release-branch environment secrets (includes EXTENSION_PUBLISH_TOKEN)
    environment: release-branch
    timeout-minutes: 30
    env:
      # Release identifiers (from validate-branch job)
      RELEASE_TAG: ${{ needs.validate-branch.outputs.tag }}
      RELEASE_SHA: ${{ needs.validate-branch.outputs.release-sha }}
      FLASK_TAG: ${{ needs.validate-branch.outputs.tag }}-flask.0
      # Publishing tokens
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      # Override default GITHUB_TOKEN with EXTENSION_PUBLISH_TOKEN for release creation
      GITHUB_TOKEN: ${{ secrets.EXTENSION_PUBLISH_TOKEN }}
      FIREFOX_BUNDLE_SCRIPT_TOKEN: ${{ secrets.FIREFOX_BUNDLE_SCRIPT_TOKEN }}
      # Environment variables used in Firefox bundle script
      # Keep this list synchronized with:
      # * The environment variables exported by `.github/scripts/bundle.sh`
      # * The environment variables used by the `run-build` step in `.github/workflows/run-build.yml`.
      APPLE_BETA_CLIENT_ID: ${{ secrets.APPLE_BETA_CLIENT_ID }}
      APPLE_EXPERIMENTAL_CLIENT_ID: ${{ secrets.APPLE_EXPERIMENTAL_CLIENT_ID }}
      APPLE_FLASK_CLIENT_ID: ${{ secrets.APPLE_FLASK_CLIENT_ID }}
      APPLE_PROD_CLIENT_ID: ${{ secrets.APPLE_PROD_CLIENT_ID }}
      CONTENTFUL_ACCESS_SPACE_ID: ${{ secrets.CONTENTFUL_ACCESS_SPACE_ID }}
      CONTENTFUL_ACCESS_TOKEN: ${{ secrets.CONTENTFUL_ACCESS_TOKEN }}
      ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
      FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
      FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
      FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
      FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
      FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
      FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
      GOOGLE_BETA_CLIENT_ID: ${{ secrets.GOOGLE_BETA_CLIENT_ID }}
      GOOGLE_EXPERIMENTAL_CLIENT_ID: ${{ secrets.GOOGLE_EXPERIMENTAL_CLIENT_ID }}
      GOOGLE_FLASK_CLIENT_ID: ${{ secrets.GOOGLE_FLASK_CLIENT_ID }}
      GOOGLE_PROD_CLIENT_ID: ${{ secrets.GOOGLE_PROD_CLIENT_ID }}
      INFURA_BETA_PROJECT_ID: ${{ secrets.INFURA_BETA_PROJECT_ID }}
      INFURA_EXPERIMENTAL_PROJECT_ID: ${{ secrets.INFURA_EXPERIMENTAL_PROJECT_ID }}
      INFURA_FLASK_PROJECT_ID: ${{ secrets.INFURA_FLASK_PROJECT_ID }}
      INFURA_PROD_PROJECT_ID: ${{ secrets.INFURA_PROD_PROJECT_ID }}
      QUICKNODE_ARBITRUM_URL: ${{ secrets.QUICKNODE_ARBITRUM_URL }}
      QUICKNODE_AVALANCHE_URL: ${{ secrets.QUICKNODE_AVALANCHE_URL }}
      QUICKNODE_BASE_URL: ${{ secrets.QUICKNODE_BASE_URL }}
      QUICKNODE_LINEA_MAINNET_URL: ${{ secrets.QUICKNODE_LINEA_MAINNET_URL }}
      QUICKNODE_MAINNET_URL: ${{ secrets.QUICKNODE_MAINNET_URL }}
      QUICKNODE_OPTIMISM_URL: ${{ secrets.QUICKNODE_OPTIMISM_URL }}
      QUICKNODE_POLYGON_URL: ${{ secrets.QUICKNODE_POLYGON_URL }}
      QUICKNODE_SEI_URL: ${{ secrets.QUICKNODE_SEI_URL }}
      SEGMENT_BETA_WRITE_KEY: ${{ secrets.SEGMENT_BETA_WRITE_KEY }}
      SEGMENT_EXPERIMENTAL_WRITE_KEY: ${{ secrets.SEGMENT_EXPERIMENTAL_WRITE_KEY }}
      SEGMENT_FLASK_WRITE_KEY: ${{ secrets.SEGMENT_FLASK_WRITE_KEY }}
      SEGMENT_PROD_WRITE_KEY: ${{ secrets.SEGMENT_PROD_WRITE_KEY }}
      ANALYTICS_DATA_DELETION_SOURCE_ID: ${{ secrets.ANALYTICS_DATA_DELETION_SOURCE_ID }}
      ANALYTICS_DATA_DELETION_ENDPOINT: ${{ secrets.ANALYTICS_DATA_DELETION_ENDPOINT }}
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
      SENTRY_DSN_DEV: ${{ secrets.SENTRY_DSN_DEV }}
      TZ: 'UTC' # Ensures the bundles are consistent across machine time zones
      VAPID_KEY: ${{ secrets.VAPID_KEY }}
    steps:
      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: true
          skip-allow-scripts: true
          ref: ${{ needs.validate-branch.outputs.release-sha }}
          fetch-depth: 0
          use-yarn-hydrate: true

      - name: Download artifact 'build-dist-browserify'
        uses: actions/download-artifact@v4
        with:
          path: build-dist-browserify
          name: build-dist-browserify

      - name: Publish main release to Sentry
        run: yarn sentry:publish --dist-directory build-dist-browserify/dist

      - name: Download artifact 'build-dist-mv2-browserify'
        uses: actions/download-artifact@v4
        with:
          path: build-dist-mv2-browserify
          name: build-dist-mv2-browserify

      - name: Publish main MV2 release to Sentry
        run: yarn sentry:publish --dist mv2 --dist-directory build-dist-mv2-browserify/dist

      - name: Download artifact 'build-flask-browserify'
        uses: actions/download-artifact@v4
        with:
          path: build-flask-browserify
          name: build-flask-browserify

      - name: Publish Flask release to Sentry
        run: yarn sentry:publish --build-type flask --dist-directory build-flask-browserify/dist

      - name: Download artifact 'build-flask-mv2-browserify'
        uses: actions/download-artifact@v4
        with:
          path: build-flask-mv2-browserify
          name: build-flask-mv2-browserify

      - name: Publish Flask MV2 release to Sentry
        run: yarn sentry:publish --build-type flask --dist mv2 --dist-directory build-flask-mv2-browserify/dist

      - name: Create GitHub release
        run: .github/scripts/release-create-gh-release.sh

      - name: Push Firefox bundle script
        run: .github/scripts/push-firefox-bundle-script.sh

      - name: Summary
        env:
          VERSION: ${{ needs.validate-branch.outputs.version }}
        run: |
          {
            echo "## Release Published"
            echo ""
            echo "| Component | Status |"
            echo "|-----------|--------|"
            echo "| Sentry (main) | ✅ Published |"
            echo "| Sentry (main MV2) | ✅ Published |"
            echo "| Sentry (Flask) | ✅ Published |"
            echo "| Sentry (Flask MV2) | ✅ Published |"
            echo "| GitHub Release | ✅ Created |"
            echo "| Firefox Bundle | ✅ Pushed |"
            echo ""
            echo "**Release:** [${RELEASE_TAG}](https://github.com/${{ github.repository }}/releases/tag/${RELEASE_TAG})"
          } >> "${GITHUB_STEP_SUMMARY}"
